##########################################################################
# This file contains MiCADO Profile type definitions.
##########################################################################

tosca_definitions_version: tosca_2_0

profile: eu.swarmchestrate:0.1

metadata:
  template_name: profile.yaml
  template_author: University of Westminster
  template_version: 0.1

description: MiCADO Profile type definitions

imports:
- namespace: capacity
  url: https://raw.githubusercontent.com/Swarmchestrate/tosca/refs/heads/main/profiles/eu.swarmchestrate/capacity.yaml


data_types:

  PortMapping:
    description: >
      For specifying ports in a container.
    properties:
      containerPort:
        type: integer
        required: false
        description: >
          Informational only - port inside the container.
      port:
        description: >
          The port number to expose targetPort to.
        type: integer
        required: true
      targetPort:
        description: >
          The port number inside the container to map to.
        type: integer
        required: false
      nodePort:
        description: >
          A port in range 30000-32767 available on all nodes.
        type: integer
        required: false

  RawMetric:
    properties:
      name:
        type: string
        required: true
        description: Name of the raw metric
      sensor:
        type: string
        required: true
        description: Sensor type
        default: Netdata
      config:
        type: map
        required: true
        entry_schema: string
        description: |
          Configuration for the metric e.g.
            scope_contexts: k8s.cgroup.cpu
            results-aggregation: SUM
      collection_frequency:
        type: string
        required: true
        description: Frequency of collection e.g. "30 sec"
        default: "30 sec"
      collection_output:
        type: string
        required: true
        description: Output type e.g. "all"
        default: "all"

  CompositeMetric:
    description: >
      Composite metric definition.
    properties:
      name:
        type: string
        required: true
        description: Name of the composite metric
      formula:
        type: string
        required: true
        description: Formula for the composite metric e.g. mean( cpu_util_instance )
      collection_frequency:
        type: string
        required: true
        description: Frequency of collection e.g. "30 sec"
        default: "30 sec"
      collection_output:
        type: string
        required: true
        description: Output type e.g. "all"
        default: "all"
      window_type:
        type: string
        required: true
        description: Type of window e.g. "sliding"
        default: "sliding"
      window_size:
        type: string
        required: true
        description: Size of the window e.g. "5 min"
      grouping:
        type: string
        required: true
        description: >
          Grouping type e.g. "per_zone", "per_host", "per_region" # possibly "cross-swarms"
        default: "per_zone"

  SLO:
    description: >
      Service Level Objective (SLO) data type.
    properties:
      name:
        type: string
        required: true
        description: Name of the SLO
      metric:
        type: string
        required: false
        description: Name of the metric to apply the SLO on
      operator:
        type: string
        required: false
        description: Operator for the SLO e.g. ">"
      threshold:
        type: float
        required: false
        description: Threshold value for the SLO e.g. 80.0
      and_list:
        type: list
        entry_schema: SLO
        required: false
        description: List of SLOs to AND together
      or_list:
        type: list
        entry_schema: SLO
        required: false
        description: List of SLOs to OR together
      constraint:
        type: string
        required: false
        description: Constraint for the SLO e.g. "cpu_util_prct > 80"

node_types:

  Swarm:
    description: >
      The Swarmchestrate Swarm node represents the resources that come
      together to form a swarm.
    properties:
      name:
        type: string
        required: false
        description: >
          The name of the swarm.

  Application:
    derived_from: Microservice

  Microservice:
    derived_from: Kubernetes.APIObject
    description: >
      Convenience workload type for a containerised microservice expressed as a
      Kubernetes API object. This type inherits name/namespace/labels/annotations
      from Kubernetes.Base and apiVersion/kind/spec from Kubernetes.APIObject, and
      adds commonly used Deployment-style and container runtime properties.

    properties:

      # Workload shape
      replicas:
        type: integer
        required: false
        description: >
          Desired number of workload instances to run concurrently.

      selector:
        type: map
        required: false
        entry_schema: string
        description: >
          Label selector used to associate the workload with managed Pods. If
          omitted, the orchestrator may derive a selector from labels.

      strategy:
        type: map
        required: false
        entry_schema: string
        description: >
          Rollout strategy configuration for the workload (e.g. rolling update
          parameters).

      revision_history_limit:
        type: integer
        required: false
        description: >
          Number of prior ReplicaSets to retain for rollback.

      min_ready_seconds:
        type: integer
        required: false
        description: >
          Minimum number of seconds a new Pod should be ready before it is
          considered available.

      progress_deadline_seconds:
        type: integer
        required: false
        description: >
          Maximum time in seconds for the workload to make progress before it is
          considered failed.

      # Container selection (primary container)
      image:
        type: string
        required: true
        description: >
          OCI container image reference to run for the primary container.

      image_pull_policy:
        type: string
        required: false
        description: >
          Image pull behaviour for the container. Common values include
          'Always', 'IfNotPresent', and 'Never'.

      image_pull_secrets:
        type: list
        required: false
        entry_schema:
          type: string
        description: >
          List of Secret names used to authenticate to container registries.

      # Docker-style runtime properties
      entrypoint:
        type: list
        required: false
        entry_schema:
          type: string
        description: >
          Entrypoint override for the container.

      cmd:
        type: list
        required: false
        entry_schema:
          type: string
        description: >
          Default arguments passed to the entrypoint.

      workdir:
        type: string
        required: false
        description: >
          Working directory inside the container.

      user:
        type: string
        required: false
        description: >
          User identity the container process should run as (name or numeric id).

      # Kubernetes-style runtime properties
      command:
        type: list
        required: false
        entry_schema:
          type: string
        description: >
          Command to execute in the container. If provided, this is treated as
          the authoritative command for the container.

      args:
        type: list
        required: false
        entry_schema:
          type: string
        description: >
          Arguments to pass to the container command. If provided, this is treated
          as the authoritative argument list for the container.

      working_dir:
        type: string
        required: false
        description: >
          Working directory inside the container. If set, this is treated as the
          authoritative working directory.

      # Environment
      env:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Environment variables for the container. Each item should include at
          least 'name' and either 'value' or a value source reference.

      env_from:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Bulk environment sources (e.g. ConfigMap or Secret references).

      # Networking
      ports:
        type: list
        required: false
        entry_schema:
          type: PortMapping
        description: >
          Container ports to declare (and optionally expose via a Service).

      hostname:
        type: string
        required: false
        description: >
          Hostname to set for the container.

      dns_policy:
        type: string
        required: false
        description: >
          DNS policy for the Pod (e.g. 'ClusterFirst').

      dns_config:
        type: map
        required: false
        entry_schema: string
        description: >
          DNS configuration customisation for the Pod (nameservers, searches, options).

      # Identity and security
      service_account:
        type: string
        required: false
        description: >
          ServiceAccount name the Pod should run as.

      automount_service_account_token:
        type: boolean
        required: false
        description: >
          Whether to automatically mount the ServiceAccount token into the Pod.

      security_context:
        type: map
        required: false
        entry_schema: string
        description: >
          Pod-level security context settings (e.g. fsGroup, runAsUser).

      container_security_context:
        type: map
        required: false
        entry_schema: string
        description: >
          Container-level security context settings (e.g. runAsNonRoot, capabilities).

      # Storage
      volumes:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Volume declarations used by the Pod template.

      volume_mounts:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Volume mount definitions for the container filesystem. Each item should
          include at least 'mountPath' and either a volume reference or name.

      # Resources
      resources:
        type: map
        required: false
        entry_schema: string
        description: >
          Resource requests and limits (e.g. cpu and memory) for the container.

      # Health checks
      liveness_probe:
        type: map
        required: false
        entry_schema: string
        description: >
          Liveness probe definition used to detect and restart unhealthy containers.

      readiness_probe:
        type: map
        required: false
        entry_schema: string
        description: >
          Readiness probe definition used to determine when the workload can
          receive traffic.

      startup_probe:
        type: map
        required: false
        entry_schema: string
        description: >
          Startup probe definition used to delay other probes until the container starts.

      # Lifecycle
      lifecycle:
        type: map
        required: false
        entry_schema: string
        description: >
          Lifecycle hooks for the container (e.g. postStart, preStop).

      termination_grace_period_seconds:
        type: integer
        required: false
        description: >
          Time in seconds to allow for graceful termination before force kill.

      # Scheduling
      node_selector:
        type: map
        required: false
        entry_schema: string
        description: >
          Node selector constraints for scheduling Pods.

      affinity:
        type: map
        required: false
        entry_schema: string
        description: >
          Affinity and anti-affinity rules for scheduling Pods.

      tolerations:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Tolerations that allow Pods to schedule onto tainted nodes.

      topology_spread_constraints:
        type: list
        required: false
        entry_schema:
          type: map
        description: >
          Constraints to spread Pods across topology domains (e.g. zones, nodes).

      priority_class_name:
        type: string
        required: false
        description: >
          PriorityClass name to influence scheduling priority.

      # Pod specific metadata

      pod_annotations:
        type: map
        required: false
        entry_schema: string
        description: >
          Annotations to apply specifically to Pods created by this workload, distinct
          from the resource-level annotations.

      pod_labels:
        type: map
        required: false
        entry_schema: string
        description: >
          Labels to apply specifically to Pods created by this workload, distinct from
          the resource-level labels.

    requirements:
      - host:
          capability: Resource
          relationship: HostedOn
      - volume:
          capability: Volume
          relationship: AttachesTo


  AbstractResource:
    description: >
      The Swarmchestrate Resource node represents an unselected resource

  Resource:
    description: >
      The Swarmchestrate Resource node represents a cloud or edge instance
    derived_from: AbstractResource
    properties:
      ssh_user:
        type: string
        required: true
        description: >
          The SSH user for accessing the instance.
        default: ubuntu
    capabilities:
      host:
        type: Resource
        properties:
          num-cpus:
            type: integer
            required: true
            description: Number of vCPUs
          mem-size:
            type: integer
            required: true
            description: Memory size in GB
          disk-size:
            type: integer
            required: true
            description: Disk size in GB
          bandwidth:
            type: integer
            required: true
            description: Network bandwidth in Mbps
      os:
        properties:
          type:
            type: string
            required: true
            description: Operating system type
            default: linux
          version:
            type: string
            required: true
            description: Operating system version
          distribution:
            type: string
            required: true
            description: Operating system distribution
      resource:
        properties:
          provider:
            type: string
            required: true
            description: Resource provider
          capacity-provider:
            type: string
            required: true
            description: Capacity provider
          type:
            type: string
            required: true
            description: Resource type
      pricing:
        properties:
          cost:
            type: float
            required: true
            description: Cost per hour in USD
      locality:
        properties:
          continent:
            type: string
            required: true
            description: Continent where the resource is located
          country:
            type: string
            required: true
            description: Country where the resource is located
          city:
            type: string
            required: true
            description: City where the resource is located
      energy:
        properties:
          consumption:
            type: float
            required: true
            description: Energy consumption in watts per hour
          powered-type:
            type: string
            required: false
            description: Type of power used (e.g., renewable, non-renewable)
          energy-type:
            type: string
            required: false
            description: Specific type of energy (e.g., solar, wind, coal)

  EdgeResource:
    derived_from: Resource
    description: >
      The Swarmchestrate Resource node represents an edge instance
    properties:
      ssh_key:
        type: string
        required: true
        description: >
          Path to SSH key for accessing the edge instance.
        default: /home/ubuntu/.ssh/id_rsa # change as needed
      ssh_auth_method:
        type: string
        required: true
        description: >
          SSH authentication method (key or password).
        default: key
      edge_device_ip:
        type: string
        required: true
        description: >
          The IP address of the edge device.
    capabilities:
      resource:
        properties:
          type:
            type: string
            required: true
            description: Resource type
            default: edge

  CloudResource:
    derived_from: Resource
    description: >
      The Swarmchestrate Resource node represents a cloud instance
    properties:
      image_id:
        type: string
        required: true
        description: >
          The ID of the image used to launch the instance.
      instance_type:
        type: string
        required: true
        default: m2.small
        description: >
          The type of flavour id (e.g., m2.small) specifying compute resources.
      key_name:
        type: string
        required: false
        description: >
          The path to the SSH key pair used to access the instance.
      security_group_id:
        type: string
        description: >
          A security group ID that controls inbound and outbound traffic for the instance.
      custom_ingress_ports:
        type: map
        required: false
        entry_schema: string
        description: >
          Key-value pairs (from, to, protocol, source)
        default:
          protocol: "tcp"
          source: "0.0.0.0/0"
          from: "80"
          to: "80"
      custom_egress_ports:
        type: map
        required: false
        entry_schema: string
        description: >
          Key-value pairs (from, to, protocol, source)
        default:
          destination: "0.0.0.0/0"
          from: "0"
          to: "65535"
          protocol: "tcp"
    capabilities:
      resource:
        properties:
          type:
            type: string
            required: true
            description: Resource type
            default: cloud


  OpenStack.SZTAKI.m2.small: # Change as required
    derived_from: CloudResource
    description: >
      An OpenStack compute node from the SZTAKI provision
    properties:
      image_id:
        type: string
        required: true
        description: >
          The ID of the OpenStack image used to launch the instance.
        default: b2be6f4e-ebd8-42af-a526-63691a4d90ea
      instance_type:
        type: string
        required: true
        default: m2.small
        description: >
          The type of OpenStack flavour id (e.g., m2.small) specifying compute resources.
      key_name:
        type: string
        required: false
        description: >
          The path to the SSH key pair used to access the OpenStack instance.
        default: /home/ubuntu/.ssh/id_rsa
      security_group_id:
        type: string
        description: >
          A security group ID that controls inbound and outbound traffic for the OpenStack instance.
        default: f05b97f0-140a-4d24-bfc6-3a197e842739
      network_id:
        type: string
        required: true
        description: >
          The network ID to which the OpenStack instance will be connected.
        default: bbe042e4-91a1-4601-962f-14a31e5e2787
      floating_ip_pool:
        type: string
        required: true
        description: >
          The floating IP pool name for the OpenStack instance.
        default: ext-net
      use_block_device:
        type: boolean
        required: true
        description: >
          Whether to use a block device for storage.
        default: true
      volume_size:
        type: integer
        required: true
        description: >
          The size of the volume in GB if using block device.
        default: 10
    capabilities:
      host:
        type: Resource
        properties:
          num-cpus:
            type: integer
            required: true
            description: Number of vCPUs
            default: 2 # Change to actual m2.small
          mem-size:
            type: integer
            required: true
            description: Memory size in GB
            default: 1 # Change to actual m2.small
          disk-size:
            type: integer
            required: true
            description: Disk size in GB
            default: 20 # Change to actual m2.small
          bandwidth:
            type: integer
            required: true
            description: Network bandwidth in Mbps
            default: 100 # Change to actual m2.small
      os:
        properties:
          version:
            type: string
            required: true
            description: Operating system version
            default: "22.04" # Change to actual image_id
          distribution:
            type: string
            required: true
            description: Operating system distribution 
            default: ubuntu
      resource:
        properties:
          provider:
            type: string
            required: true
            description: Resource provider
            default: OpenStack
          capacity-provider:
            type: string
            required: true
            description: Capacity provider
            default: SZTAKI
      pricing:
        properties:
          cost:
            type: float
            required: true
            description: Cost per hour in USD
            default: 0.000 # Change to actual cost
      locality:
        properties:
          continent:
            type: string
            required: true
            description: Continent where the resource is located
            default: Europe
          country:
            type: string
            required: true
            description: Country where the resource is located
            default: Hungary
          city:
            type: string
            required: true
            description: City where the resource is located
            default: Budapest
      energy:
        properties:
          consumption:
            type: float
            required: true
            description: Energy consumption in watts per hour
            default: 13.0 # Change to actual consumption
          powered-type:
            type: string
            required: false
            description: Type of power used (e.g., renewable, non-renewable)
            default: mains-powered # Change to actual power type
          energy-type:
            type: string
            required: false
            description: Specific type of energy (e.g., solar, wind, coal)
            default: non-green # Change to actual energy type

  EC2.micro.t3:
    derived_from: CloudResource
    description: >
      An EC2 compute node from the University of Westminster provision
    properties:
      region_name:
        type: string
        required: true
        description: >
          AWS region defaults to us-east-1
        default: us-east-1
      image_id:
        type: string
        required: true
        description: >
          The ID of the Amazon Machine Image (AMI) used to launch the EC2 instance.
        default: ami-0c02fb55956c7d316
      instance_type:
        type: string
        required: true
        default: t3.micro
        description: >
          The type of EC2 instance (e.g., t2.micro, m5.large) specifying compute resources.
      key_name:
        type: string
        required: false
        description: >
          The name of the SSH key pair used to access the EC2 instance.
        default: g-key
      security_group_id:
        type: string
        description: >
          A list of security group IDs that control inbound and outbound traffic for the EC2 instance.
        default:
        - sg-0bb1c123456789abc
      tags:
        type: map
        required: false
        entry_schema: string
        description: >
          Key-value pairs used to tag and categorise the EC2 instance (e.g., environment: production).
        default:
          managed_by: swarmchestrate
    capabilities:
      host:
        type: Resource
        properties:
          num-cpus:
            type: integer
            required: true
            description: Number of vCPUs
            default: 2
          mem-size:
            type: integer
            required: true
            description: Memory size in GB
            default: 1
          disk-size:
            type: integer
            required: true
            description: Disk size in GB
            default: 20
          bandwidth:
            type: integer
            required: true
            description: Network bandwidth in Mbps
            default: 100
      os:
        properties:
          type:
            type: string
            required: true
            description: Operating system type
            default: linux
          version:
            type: string
            required: true
            description: Operating system version
            default: "22.04"
          distribution:
            type: string
            required: true
            description: Operating system distribution 
            default: ubuntu
      resource:
        properties:
          provider:
            type: string
            required: true
            description: Resource provider
            default: Amazon
          capacity-provider:
            type: string
            required: true
            description: Capacity provider
            default: uow
      pricing:
        properties:
          cost:
            type: float
            required: true
            description: Cost per hour in USD
            default: 0.0139
      locality:
        properties:
          continent:
            type: string
            required: true
            description: Continent where the resource is located
            default: N.America
          country:
            type: string
            required: true
            description: Country where the resource is located
            default: USA
          city:
            type: string
            required: true
            description: City where the resource is located
            default: N.Virginia
      energy:
        properties:
          consumption:
            type: float
            required: true
            description: Energy consumption in watts per hour
            default: 13.0
          powered-type:
            type: string
            required: false
            description: Type of power used (e.g., renewable, non-renewable)
            default: mains-powered
          energy-type:
            type: string
            required: false
            description: Specific type of energy (e.g., solar, wind, coal)
            default: non-green

  MonitoredComponent:
    description: General base type for components that can be monitored in SwCh.
    capabilities:
      metrics:
        type: Metric
        properties:
          raw:
            type: list
            required: false
            description: Raw metrics
            entry_schema: RawMetric
          composite:
            type: list
            required: false
            description: Composite metrics
            entry_schema: CompositeMetric
      slo-constraints:
        type: SLO
          


  Kubernetes.Base:
    derived_from: MonitoredComponent
    description: >
      General base type for Kubernetes-related modelling. This type captures
      commonly useful metadata (name/namespace/labels/annotations) without
      assuming the node is a Kubernetes API object. Derive concrete API-object
      types (with apiVersion/kind/spec) and embedded-spec types (e.g. volumes)
      from this base.
    properties:
      name:
        type: string
        required: false
        description: >
          Optional identifier for the Kubernetes-related entity. For API objects,
          this should correspond to the Kubernetes metadata.name. For embedded
          constructs, this can be used as a local reference name.
      namespace:
        type: string
        required: false
        description: >
          Optional namespace. Applicable to namespaced API objects; typically
          ignored for embedded constructs.
      labels:
        type: map
        required: false
        entry_schema: string
        description: >
          Optional key/value labels for selection, grouping, and organisation.
      annotations:
        type: map
        required: false
        entry_schema: string
        description: >
          Optional key/value annotations for non-identifying metadata used by
          tooling, controllers, and integrations.

  Kubernetes.APIObject:
    derived_from: Kubernetes.Base
    description: >
      Base type for Kubernetes API objects (persisted resources that can be
      created/applied on their own, e.g. Service, Deployment, ServiceAccount).
      Adds the required Kubernetes API identity fields and a free-form spec.
    properties:
      apiVersion:
        type: string
        required: false
        description: >
          Kubernetes API version for the resource (e.g. "v1", "apps/v1").
      kind:
        type: string
        required: false
        description: >
          Kubernetes resource kind (e.g. "Service", "Deployment").
      spec:
        type: map
        required: false
        entry_schema: string
        description: >
          Resource specification content. Structure is kind-specific.

  Volume:
    derived_from: Kubernetes.Base
    description: >
      Base volume type used to model container storage that can be mounted into
      a microservice. Concrete volume types (for example EmptyDir and HostPath)
      derive from this type.

  Volume.EmptyDir:
    derived_from: Volume
    description: >
      Ephemeral scratch volume whose lifecycle is tied to the workload instance.
      It is created when the workload starts and removed when the workload stops.
      Equivalent intent to Kubernetes emptyDir.
    properties:
      medium:
        type: string
        required: false
        validation: { $valid_values: [ $value, [ "", "Memory" ] ] }
        description: >
          Storage medium for the emptyDir. Use "" for node storage (default) or
          "Memory" to request a tmpfs-backed in-memory volume (size may be limited
          by the platform).
      sizeLimit:
        type: string
        required: false
        description: >
          Optional upper bound for the volume size (for example "512Mi", "1Gi"),
          interpreted by the orchestrator/platform where supported.

  Volume.HostPath:
    derived_from: Volume
    description: >
      Volume backed by a directory or file path on the host (node) filesystem,
      mounted into the workload. Equivalent intent to Kubernetes hostPath.
      Use with care as it couples the workload to the host's filesystem layout.
    properties:
      path:
        type: string
        required: true
        description: >
          Absolute path on the host machine to mount into the workload.
          
policy_types:

  Scheduling:
    description: >
      Policy type for scheduling.


  Scheduling.Colocation:
    derived_from: Scheduling
    description: >
      Policy type for colocating multiple microservices on a specific host.

      

  RegistryLogin:
    description: >
      Policy type for logging into a container registry.
    properties:
      username:
        type: string
        required: true
        description: >
          The username for the container registry.
      password:
        type: string
        required: true
        description: >
          The password or token for the container registry.
      registry_url:
        type: string
        required: true
        description: >
          The URL of the container registry.

  QoS:
    description: >
      Quality of Service (QoS) policies for applications.
    properties:
      priority:
        type: float
        required: false
        description: >
          Priority level of the application (higher number means higher priority).
      target:
        type: integer
        required: false
        description: >
          Target value for the QoS metric.

  QoS.Energy.Budget:
    description: >
      Energy policy type
    derived_from: QoS

  QoS.Cost.Budget:
    description: >
      Cost policy type
    derived_from: QoS

  QoS.Performance.Bandwidth:
    description: >
      Bandwidth policy type
    derived_from: QoS

  QoS.Performance.Latency:
    description: >
      Latency policy type
    derived_from: QoS


relationship_types:

  HostedOn:
    description: >
      This relationship indicates that a node is hosted on another node.

  AttachesTo:
    description: >
      This relationship indicates that a volume is attached to a container.
    properties:
      mount_path:
        type: string
        required: true
        description: Path to mount to in Pod

  IdentifiesAs:
    description: >
      This relationship indicates that a workload identifies with an account.

capability_types:

  Resource:
    description: >
      This capability represents a resource that can host applications.

  Volume:
    description: >
      This capability represents a volume that can be attached to a container.

  Metric:
    description: >
      This capability represents metrics.

  SLO:
    description: >
      Service Level Objective (SLO) definition.
    properties:
      name:
        type: string
        required: true
        description: Name of the SLO
        default: "default-slo"
      metric:
        type: string
        required: false
        description: Name of the metric to apply the SLO on
      operator:
        type: string
        required: false
        description: Operator for the SLO e.g. ">"
      threshold:
        type: float
        required: false
        description: Threshold value for the SLO e.g. 80.0
      and_list:
        type: list
        entry_schema: SLO
        required: false
        description: List of SLOs to AND together
      or_list:
        type: list
        entry_schema: SLO
        required: false
        description: List of SLOs to OR together
      constraint:
        type: string
        required: false
        description: Constraint for the SLO e.g. "cpu_util_prct > 80"